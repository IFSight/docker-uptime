#!/bin/sh

# set -x

DOCKER=`which docker`

if [ $? -ne 0 ]; then
  echo "Docker does not exist on the path, please visit https://docs.docker.com/engine/installation" >&2
  exit 1
fi

DOCKER_COMPOSE=`which docker-compose`

DESTDIR=/usr/local

if [[ "$(uname -a)" == *"coreos"* ]]; then
  DESTDIR=/opt
fi

if [ $? -ne 0 ]; then
  DOCKER_COMPOSE=$DESTDIR/bin/docker-compose

  echo "Docker Compose does not exist, getting it"

  curl -L https://github.com/docker/compose/releases/download/1.7.1/docker-compose-`uname -s`-`uname -m` | sudo tee $DOCKER_COMPOSE > /dev/null

  sudo chmod +x $DOCKER_COMPOSE
fi

# clone the repo to $DESTDIR/docker-uptime
if [ ! -d $DESTDIR/docker-uptime ]; then
  echo "Cloning https://github.com/IFSight/uptime.git"

  sudo git clone https://github.com/IFSight/uptime.git $DESTDIR/docker-uptime
else
  echo "Updating from https://github.com/IFSight/uptime.git"

  cd $DESTDIR/docker-uptime

  sudo git pull

  echo "Stopping and removing containers if they exist, then pulling"
  sudo -- sh -c "$DOCKER_COMPOSE --file $DESTDIR/docker-uptime/compose/uptime.yml stop"
  sudo -- sh -c "$DOCKER_COMPOSE --file $DESTDIR/docker-uptime/compose/uptime.yml rm -f"
  sudo -- sh -c "$DOCKER_COMPOSE --file $DESTDIR/docker-uptime/compose/uptime.yml pull"
fi

echo "Starting everything up"
sudo -- sh -c "$DOCKER_COMPOSE --file $DESTDIR/docker-uptime/compose/uptime.yml up -d"

MYIP=$(curl -L raw.ip.ifsight.net)
echo "To see uptime web GUI, visit http://$MYIP:8082/"
